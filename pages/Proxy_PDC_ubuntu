Vamos a sustituir el [[Proxy freebsd]] por un equipo que efectúe las siguientes funciones:

*controlador primario de dominio (PDC), que sustituirá al PC de Lara (y éste pasará a ser un equipo más)
*servidor de archivos compartidos
*servidor de correo interno, que sustituirá al MailEnable
*servidor de fax

Y estas otras que ya existían:
*servidor DHCP, que facilita la configuración de equipos de operadora
*proxy, que filtra las páginas que ven las operadoras

Empezamos tras instalar un sistema base de Ubuntu i386 Server 6.06 LTS. Habilitar ssh. Para configurar las funciones a desempeñar, es necesario ser root.

== Servidor DHCP ==
Proporciona automáticamente direcciones IP a los equipos de las teleoperadoras.
 # apt-get install dhcp3-server

Editar /etc/dhcp3/dhcpd.conf
 ######### dhcpd.conf #########
 #
 #option domain-name "nostel.net";
 option domain-name-servers 80.58.61.250, 80.58.61.254;
 #
 
 default-lease-time 18200;
 max-lease-time 21400;
 #
 authoritative;
 ddns-update-style none;
 #
 subnet 192.168.0.0 netmask 255.255.255.0 {
  range 192.168.0.20 192.168.0.254;
  option routers 192.168.0.1;
  option broadcast-address 192.168.0.255;
 }
 #
 #EOF


== Enrutador y proxy ==
Habilitamos los repositorios universe. Despues instalamos los paquetes:
 # apt-get install squid squidguard
Modificar /etc/squid/squid.conf
 visible_hostname nostelpdc
 
 http_port 3128
 #las siguientes 3 directivas sólo son para squid 2.5.x, en 2.6.x se cambian por http_port 3128 transparent arriba
 httpd_accel_host virtual
 httpd_accel_port 80
 httpd_accel_uses_host_header on
 
 cache_mgr info@tiendasconexion.com
 cache_effective_user proxy
 cache_effective_group proxy
 cache_access_log /var/log/squid/access.log
 cache_store_log /var/log/squid/store.log
 cache_log /var/log/squid/cache.log
 emulate_httpd_log on
 
 redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
 redirect_children 6
 
 acl all src 0/0
 acl localhost src 127.0.0.1/255.255.255.255
 acl nostel src 192.168.0.0/255.255.255.0
 
 http_access allow localhost
 http_access allow nostel
 http_access deny all
 
 no_cache deny all
 
 delay_pools 2
 
 request_body_max_size 2048 KB
 
 logfile_rotate 7
Modificar /etc/squid/squidGuard.conf de tal modo que los PCs con acceso restringido coincidan con el rango de IPs automático:

 dbhome /var/lib/squidguard/db
 logdir /var/log/squid
 
 src sinrestriccion {
         ip      192.168.0.1-192.168.0.19
 }
 
 dest restringido {
         #log             websoperadoras
         domainlist      websoperadoras/domains
         #urllist         websoperadoras/urls
 }
 
 acl {
         sinrestriccion {
                 pass all
         }
         default {
                 pass restringido none
                 #pass !gambling !warez all
                 redirect http://192.168.0.1
         }
 }

Crear el directorio de dominios restringidos
 # mkdir /var/lib/squidguard/db/websoperadoras
Modificar /var/lib/squidguard/db/websoperadoras/domains con los dominios que permitimos acceso. Aplicar con:
 squidGuard -C all
Para evitar problemas (squid muere):
 chown -R proxy:proxy /var/lib/squidguard
Preparar squid y su estructura de cache. Para la próxima, deshabilitar caché en compilación:
 # squid -z
Redirigir el tráfico del puerto 80 al 3128. Eliminar tráfico de messenger (ver hosts con netstat -an)
 # nano /etc/init.d/firewall.sh
 echo 1 > /proc/sys/net/ipv4/ip_forward
 iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -d 0.0.0.0/0 -j MASQUERADE
 iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j REDIRECT --to-port 3128
 iptables -A FORWARD -p tcp --dport 1863 -j DROP
 iptables -A FORWARD -p tcp -d 65.54.239.81/16 -j DROP
 iptables -A FORWARD -p tcp -d 207.46.30.34/16 -j DROP
 iptables -A OUTPUT -p tcp -d 65.54.239.81/16 -j DROP
 iptables -A OUTPUT -p tcp -d 207.46.30.34/16 -j DROP

El MSN utiliza el 1863, pero si es cortado, cambia al 80. Por tanto hay que cargarse todo el rango de IPs.

Establecerlo como servicio en todos los runlevels:
 # chmod +x /etc/init.d/firewall.sh
 # update-rc.d firewall.sh defaults

* http://www.netfilter.org/documentation/HOWTO/es/NAT-HOWTO-7.html
* http://glove.org.ve/pipermail/l-ayuda/2006-January/000996.html
* http://www.tuxjm.net/docs/netfilter-port-forwarding.txt
* http://www.hackorama.com/network/portfwd.shtml

== Controlador primario de dominio ==
Vamos a establecer un PDC mediante [[Samba]]. No empleamos perfiles itinerantes.

Creamos los usuarios:
*atac
*lara
*laura
*fidelizacion
*juani
*operadora
*reyes
mendiante la orden...
 # useradd -c NOMBRECOMPLETO -d /dev/null -g usuario -s /bin/false NOMBRE
..dentro del grupo ''usuario'' (para que a la hora de aplicarse los permisos del sistema de archivos no haya problemas). La clave que se introduzca es indiferente, no se aplica; hay que fijar y crear las claves Samba para todos estos usuarios (con smbpasswd -a).

Ahora el grupo para las máquinas del dominio.
 # addgroup nostelpdc
Las máquinas crean su usuario al unirse por primera vez.

Creamos las carpetas compartidas, y establecemos sus permisos. No es necesario reiniciar smbd para aplicar estos cambios.
Las carpetas compartidas se mapean con una carpeta local. Cuando un usuario trata de leer/escribir en una compartida, primero se aplican los permisos de Samba y a continuación los de UNIX.
Hacemos estas carpetas pertenecientes a usuario:usuario con acceso 775. Cada vez que un usuario modifica un archivo, se cambia el nombre del propietario, y los permisos del mismo.
 # ll
 drwxrwxr-x 3 usuario usuario 1024 2006-12-20 17:01 ATAC
 drwxrwxr-x 2 usuario usuario 1024 2007-01-02 18:22 backup
 drwxrwxr-x 4 usuario usuario 1024 2006-12-20 17:01 BBDD
 drwxrwxr-x 6 usuario usuario 1024 2006-12-20 17:02 CAMP. COLECTIVOS
 drwxrwxr-x 4 usuario usuario 1024 2006-12-20 17:07 COLECTIVOS
 drwxrwxr-x 2 usuario usuario 1024 2006-12-20 17:02 Duplicados
 drwxrwxr-x 3 usuario usuario 1024 2006-12-20 17:04 Fidelizacion
 drwxrwxr-x 7 usuario usuario 1024 2006-12-20 17:05 HOME
 drwxrwxr-x 8 usuario usuario 1024 2006-12-20 17:06 HOME LARA
 drwxrwxr-x 6 usuario usuario 1024 2006-12-20 17:06 Informes
 drwxrwxr-x 2 usuario usuario 1024 2006-12-20 17:06 ST
 drwxrwxr-x 2 usuario usuario 1024 2006-12-20 17:06 Stock
 drwxrwxr-x 6 usuario usuario 1024 2006-12-20 17:07 Teleoperadoras
 drwxrwxr-x 2 usuario usuario 1024 2006-12-20 17:07 UPS
Después, las configuramos para que aparezcan al examinar los recursos:
 [ATAC]
        path = /home/usuario/ATAC
        valid users = lara,reyes,atac
        write list = lara,reyes,atac
 [BASE DATOS ORANGE]
        path = /home/usuario/BBDD
        valid users = lara,laura,juani
        write list = lara,laura,juani
 [CAMP. COLECTIVOS]
        path = /home/usuario/CAMP. COLECTIVOS
        valid users = lara,laura,juani,atac
        write list = lara,laura,juani,atac
 [COLECTIVOS]
        path = /home/usuario/COLECTIVOS
        valid users = lara,juani,operadora,reyes
        write list = lara,juani,operadora
 [Duplicados]
        path = /home/usuario/Duplicados
        valid users = lara,atac,reyes
        write list = lara,atac,reyes
 [Fidelizacion]
        path = /home/usuario/Fidelizacion
        valid users = lara,fidelizacion
        write list = lara,fidelizacion
 [HOME]
        path = /home/usuario/HOME
        valid users = lara,reyes,atac
        write list = lara,reyes,atac
 [HOME LARA]
        path = /home/usuario/HOME LARA
        valid users = lara,reyes
        write list = lara,reyes
 [Informes]
        path = /home/usuario/Informes
        valid users = lara,fidelizacion,laura,juani,atac,reyes
        write list = lara,fidelizacion,laura,juani,atac,reyes
 [Servicio Tecnico]
        path = /home/usuario/ST
        valid users = lara,laura,juani
        write list = lara,laura,juani
 [Stock]
        path = /home/usuario/Stock
        valid users = lara,laura
        write list = lara,laura
 [Teleoperadoras]
        path = /home/usuario/Teleoperadoras
        valid users = lara,operadora,juani,laura
        write list = lara,juani,laura
 [UPS]
        path = /home/usuario/UPS
        valid users = lara,juani,laura
        write list = lara,juani,laura
 [Backup]
        path = /home/usuario/backup
        valid users = lara
        write list = lara

Finalmente, mapear ciertos usuarios del sistema dentro del grupo de Admins. del dominio, con el fin de facilitar la instalación de impresoras y programas en los equipos.
 # groupadd administradores
 # nano /etc/group
    administradores:x:1008:lara,laura,juani,reyes,fidelizacion,atac
 # net groupmap list
 # net groupmap modify ntgroup="Admins. del dominio" sid="S-1-5-21-3807260891-585001640-3977093787-512" unixgroup="administradores" comment="Administradores designados del dominio"
Cuando vuelvan a loguearse, serán ya administradores.

Sacamos información acerca del dominio con:
 $ net rpc info
 Domain Name: NOSTEL
 Domain SID: S-1-5-21-3807260891-585001640-3977093787
 Sequence number: 1199269458
 Num users: 39
 Num domain groups: 0
 Num local groups: 0

== Fax ==
Este equipo cumplirá las funciones del FaxNow!, con las ventajas añadidas:
*el fax no es una impresora compartida, con lo que se elimina la necesidad de que ese equipo tenga un sistema operativo Windows Server que permita más de 10 conexiones NetBIOS.
*el usuario es unico, no almacena perfiles en una carpeta compartida.
Emplearemos [http://www.hylafax.org/ HylaFAX], por su robusted y fiabilidad. Puede funcionar para recibir faxes, pero sólo lo configuraremos como envío.
Vamos a crear un archivo en PostScript para enviarle por fax.
 # vi /etc/hosts
 :hardcopy > kk.ps
Primero comprobamos que la conexión del PC al fax está bien realizada:
 # cat kk.ps > /dev/ttyS0
Instalamos los programas necesarios:
 # apt-get install hylafax-server cu
Durante la instalación, se lanza automáticamente faxsetup, y posiblemente también faxaddmodem.
El directorio principal de hylafax es /var/spool/hylafax . Los archivos de configuración residen en /var/spool/hylafax/etc y en /etc/hylafax la configuración que se está aplicando. Los archivos de ambos directorios deberían ser idénticos en fecha de creación, de lo contrario dá error, pero se soluciona reiniciando el servicio.
Seguidamente, vamos a interrogar al modem por sus capacidades, de un modo automatizado y exhaustivo (vemos los comandos AT enviados y su respuesta):
 # probemodem ttyS0
O de un modo manual:
 # cu -l ttyS0
 at+fclass=?
 ati5
 ~.

El modem debe soportar las clases 1 y 2 para poder ser usado de fax (la clase 0 es de datos).

Editamos /var/spool/hylafax/etc/hosts.hfaxd . Bien puede usarse los comandos faxadduser y faxdeluser, aunque no son tan directos.
 localhost
 127.0.0.1
 192.168.0
 ^operadora@

Editamos /var/spool/hylafax/etc/config.ttyS0 . Puede haberse hecho ya al instalar el programa y configurar el modem, con el programa faxaddmodem. Los parámetros reseñables son:
 CountryCode:    34
 AreaCode:    942
 FAXNumber:   +34.942.819815
 LongDistancePrefix:     0
 InternationalPrefix:    00
 DialStringRules:        etc/dialrules.europe
 SpeakerVolume:          off
 LocalIdentifier:        "NOSteL Comunicaciones - Orange"
 ModemType:   Class1
 ModemRate:   19200
 ModemFlowControl:       xonxoff

El volumen lo podemos regular y poner como off una vez que todo funcione. Mientras hagamos pruebas podemos ponerlo en quiet, low, medium o high.
En cuanto a la clase del fax, empleamos la 1. Delega más funciones a la CPU, pero por contra es más compatible.

Los ficheros de configuración residen doblemente en /etc/hylafax y /var/spool/hylafax/etc . Se edita la segunda, pero al reiniciar el servicio se copian al primero, que es el que realmente se aplica.

Los faxes pendientes de enviar están en /var/spool/hylafax/sendq . Podemos sacar un estado de los envíos con:
 # faxstat -d

Finalmente, hay que instalar en cada puesto de trabajo Windows el cliente. Hay dos modos de hacerlo, con una impresora compartida Samba que esté redirigida a sendfax, o con un cliente que cree un puerto de impresora y éste acceda al servicio hfaxd a través del puerto 4559.
Esta solución es la más adecuada, y usamos WinprintHylaFAX, muy [[WinprintHylaFAX|fácil de instalar]].

*http://www.hylafax.org/site1/setup.html
*http://64.233.183.104/search?q=cache:Eb57_nfDwh8J:www.linux-mag.com/id/1105/+hylafax+incoming+faxes&hl=es&ct=clnk&cd=3&gl=es&client=firefox-a
*http://www.diariolinux.com/tiki-read_article.php?articleId=21
*http://winprinthylafax.sourceforge.net/
*http://bulmalug.net/body.phtml?nIdNoticia=1662

== Correo ==
Postfix ya estará instalado, a raíz de la instalación del HylaFAX. Instalar courier mediante:
 # apt-get install courier-authdaemon courier-pop
Editar main.cf con este contenido:
 smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
 biff = no
 append_dot_mydomain = no
 relayhost = 
 inet_interfaces = 192.168.0.1, 127.0.0.1
 
 alias_maps = hash:/etc/aliases
 
 virtual_mailbox_domains = nostel.net
 virtual_mailbox_base = /var/spool/virtual
 virtual_mailbox_maps = hash:/etc/postfix/vmailbox
 virtual_minimum_uid = 100
 virtual_uid_maps = static:104
 virtual_gid_maps = static:111
La configuración es la propia de un servidor ''separated domains & non-unix accounts''.Nos aseguramos que no llega correo del exterior escuchando sólo interfaces internas.
Ahora debemos crear los directorios para los buzones del dominio virtual.
 # mkdir /var/spool/virtual
 # chmod 775 /var/spool/virtual
 # chown postfix:postfix /var/spool/virtual
 # mkdir /var/spool/virtual/nostel.net
 # chmod 775 /var/spool/virtual/nostel.net
 # chown postfix:postfix /var/spool/virtual/nostel.net

Creamos /etc/postfix/vmailbox:
 e155@nostel.net		nostel.net/e155/
 e156@nostel.net		nostel.net/e156/
 e157@nostel.net		nostel.net/e157/
 e158@nostel.net		nostel.net/e158/
 e159@nostel.net		nostel.net/e159/
 e160@nostel.net		nostel.net/e160/
 e162@nostel.net		nostel.net/e162/
 e163@nostel.net		nostel.net/e163/
 e164@nostel.net		nostel.net/e164/
 e166@nostel.net		nostel.net/e166/
 e167@nostel.net		nostel.net/e167/
 e168@nostel.net		nostel.net/e168/
 e169@nostel.net		nostel.net/e169/
 e170@nostel.net		nostel.net/e170/
 e172@nostel.net		nostel.net/e172/
 e174@nostel.net		nostel.net/e174/
 e176@nostel.net		nostel.net/e176/
 e178@nostel.net		nostel.net/e178/
 e179@nostel.net		nostel.net/e179/
 juani@nostel.net	nostel.net/juani/
 lara@nostel.net		nostel.net/lara/
 laura@nostel.net	nostel.net/laura/
 natalia@nostel.net	nostel.net/natalia/
 reyes@nostel.net	nostel.net/reyes/
Para ser precisos, no es necesaria la subcarpeta nostel.net, por que no queremos separar usuarios por dominios, pues sólo tenemos uno. El ''trailing-slash'' fuerza el uso de maildir. Generamos la base de datos:
 # postmap /etc/postfix/vmailbox

Modificar /etc/courier/authdaemonrc para que use la autenticación local (cuando vayamos a descargar el correo de un usuario local) y la autenticación de usuarios virtuales (en una base de datos propia).
 authmodulelist="authpam authuserdb"

Editar /etc/courier/userdb con los usuarios virtuales:
 e155@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e155
 e156@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e156
 e157@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e157
 e158@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e158
 e160@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e160
 e161@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e161
 e163@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e163
 e164@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e164
 e165@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e165
 e166@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e166
 e167@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e167
 e168@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e168
 e169@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e169
 e170@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e170
 e172@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e172
 e175@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e175
 e178@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e178
 e179@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=e179
 juani@nostel.net        uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=juani
 lara@nostel.net uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=lara
 laura@nostel.net        uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=laura
 natalia@nostel.net      uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=natalia
 reyes@nostel.net        uid=104|gid=111|home=/var/spool/virtual/nostel.net|systempw=bwMEag4st9HgM|mail=reyes

El contenido del campo systempw es la clave de acceso POP, y se obtiene con el comando userdbpw.
Para que este archivo sea usable, no olvidar regenerar la base de datos a partir del fichero mediante makeuserdb. Este archivo debe tener permisos 600 (sin permisos group ni world).

Los archivos y directorios de administración del sistema y sus respectivas funciones son:
*/var/spool/virtual/nostel.net : directorio del que cuelgan todos los buzones
*/etc/courier/userdb : usuarios para el acceso POP a los buzones
*/etc/postfix/vmailbox : asociación de direcciones con buzón de correo
*/etc/postfix/virtual : listas de distribución, como operadoras@nostel.net

Como detalle final, los correos que nos manda el sistema (faxmaster, root, ...) nos los redirigimos a una cuenta, modificando /etc/aliases :
 root:   usuario
 webmaster: root
 faxmaster: root

== Scripts de mantenimiento ==
Programamos unos scripts para mantener el sistema automáticamente.
=== Copias de seguridad ===
Tenemos el ejecutable /root/backup.sh :
 #!/bin/sh
 rm /home/usuario/*gz
 tar vcfz /home/usuario/backup-nostel.tar.gz /home/usuario/*
... el cual cada semana se alza gracias a cron:
 0 1     * * Sat root    /root/backup.sh
Posteriormente, desde otro servidor se recupera este archivo backup.tar.gz para almacenarlo en una unidad zip.
 wget -npr ftp://usuario:u@192.168.1.201/*gz
 mv -f *gz F:\Backups

==== FTP ====
Se efectúa la recuperación de archivos de copia de seguridad del servidor mediante el servicio FTP. Instalamos vsftp:
 # apt-get install vsftpd
 # nano /etc/vsftpd.conf
   listen=YES
   anonymous_enable=NO
   local_enable=YES
 # killall -HUP vsftpd
Sólo pueden loguear los usuarios con shell válida.

=== Logs ===
Tambien en cron borramos los logs antiguos con borralogs.sh
 10 0    * * Mon root    /root/borralogs.sh

 #!/bin/sh
 
 # de squid
 rm /var/log/squid/*
 squid -k reconfigure
 
 # del sistema
 rm /var/log/*gz
 
 # de samba
 rm /var/log/samba/*gz
 
 # del fax
 rm /var/log/hylafax/*gz

== Tareas habituales ==
Es aconsejable haberse leído el presente documento entero, sin embargo, una guía rápida de problemas típicos siempre tiene utilidad. En caso de problemas, no dejar de leer los logs para diagnosticarlos.

=== ...respecto a compartidos ===
*Establecer permisos a un compartido: modificar los parámetros valid users y write list para ajustarlos a los usuarios correctos.
*Añadir un compartido: crear el directorio en /home/usuario, darle permisos 775, listarlo en /etc/samba/smb.conf y establecer sus permisos.

En ninguno de estos casos es necesario reiniciar Samba para aplicar los cambios de /etc/samba/smb.conf .

=== ...respecto a filtro de páginas ===
*Editar los dominios permitidos: cd /var/lib/squidguard/db/websoperadoras , nano domains , squidGuard –C domains , killall –HUP squidGuard

=== ...respecto al correo interno ===
*Añadir un usuario de correo: añadir alias a vmailbox, recrear la base de datos postmap vmailbox, añadir usuario a userdb, recrear userdb.

=== ...respecto al fax ===
*Borrar la cola de envíos y el histórico de envíos: faxqclean , faxstat -d . La cola de envío está en sendq, los documentos PS que se envían en docq y los enviados en doneq. Borrar faxes con faxabort y faxrm.