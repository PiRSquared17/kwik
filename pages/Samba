[http://www.samba.org/ Samba] es una implementación libre de los protocolos SMB/CIFS de Microsoft. Actualmente va por la versión tres y funciona perfectamente como controlador primario de dominio. Permite sistema de archivos en red, como [http://www.unix.org.ua/orelly/networking_2ndEd/nfs/ch10_02.htm NFS].

Bajo Linux se configura a través del archivo /etc/samba/smb.conf . Las directivas de configuración constan de pares parámetro=valor dentro de grupos entre corchetes.

== ¿Qué es un dominio? ==
Definición: Un dominio es un grupo de cuentas y recursos de red que comparten una base de datos de directorio común y un conjunto de directivas de seguridad, y que pueden tener relaciones de seguridad con otros dominios. Un grupo de trabajo es un tipo de agrupación más básico, diseñado únicamente para ayudar a los usuarios a encontrar objetos como impresoras y carpetas compartidas en ese grupo. Los dominios son la opción recomendada para todas las redes excepto las muy pequeñas o con pocos usuarios. En un WG, los usuarios tendrán que recordar muchas contraseñas, una para cada recursos de red. Cada acceso a un recurso requiere una autenticación por parte del usuario. Por contra, un dominio es una base de datos sencilla y centralizada de cuentas de usuario, permisos y otros detalles de la red. Esta información se replica automáticamente entre todos los controladores de dominio. La autenticación del usuario y su asignación de privilegios se hace una sola vez, al loguearse en su estación de trabajo. Es posible detectar qué servidores son controladores de dominio y cuáles son simplemente miembros del mismo. Estas funciones pueden especificarse en la instalación o posteriormente. Los dominios y el sistema de directorios Active Directory (del cual forman parte), ofrecen muchas opciones para facilitar a los usuarios el acceso a los recursos, al mismo tiempo que ofrecen una supervisión y una seguridad adecuados. Extraído del Manual de Introducción de Microsoft Windows Server 2003, pág. 124 y de [http://windows.stanford.edu/docs/glossary.htm aquí].

C:\WINNT\NTDS almacena la base de datos de Active Directory y el registro de AD. C:\WINNT\SYSVOL es una copia del servidor de los archivos públicos del dominio. Este contenido se replicará a todos los DC del dominio.

Samba soporta totalmente dominios de NT4. Los dominios 2000/2003 en modo nativo (Active Directory) tienen cifrado y autenticación Kerberos, que samba no soporta completamente aún y requiere su [[Windows#Permitir_acceder_con_Samba_a_compartidos_de_Windows_2003|desactivación previa]] para acceder sin complicar la configuración de samba. Sin embargo, los dominios NT4 son 100% compatibles con máquinas 2000/XP.

No usar un dominio bajo cualquiera de los siguientes supuestos:
#la carpeta es pública para todos
#no se usan scripts personalizados de logueo
#hay pocos usuarios de terminal server, y es sencillo administrarlos
#la política de seguridad es muy relajada: no hay una jerarquía ni estructura para usuarios
#no importa que el logueo se haga por recurso en vez de una única vez (grupo de trabajo, con un tráfico de red reducido)
Por tanto no se haría preciso un W2003, sino un samba con un share público.

Las ventajas del dominio son:
#cada usuario tiene sus carpetas y sus permisos
#se usan scripts de logueo y creación de unidades de red personalizados
#hay una jerarquía de usuarios y grupos muy marcada
#se pretende centralizar la seguridad en un servidor (el controlador de dominio)
#un único y primer SSO (Single Sign On) es una necesidad dado el volumen de recursos

== Configuración básica ==
El dominio por tanto, incluye una base de datos para los usuarios del mismo, y almacena los perfiles de configuración. En Samba, para que un usuario pueda estar en la base de datos del dominio, ha de ser primero usuario del sistema UNIX. Esto es por que accede al sistema de archivos en última instancia. La configuración de Samba para actuar como PDC son unas pocas líneas del archivo /etc/samba/smb.conf :
 [global]
        workgroup = INICIOMS
        netbios name = SERVIDOR
        server string = 
        obey pam restrictions = Yes
        passdb backend = tdbsam
        passwd program = /usr/bin/passwd %u
        passwd chat = *Enter\snew\sUNIX\spassword:* %n\n *Retype\snew\sUNIX\spassword:* %n\n *password\supdated\ssuccessfully* .
        syslog = 0
        log file = /var/log/samba/log.%m
        max log size = 1000
        add machine script = /usr/sbin/useradd -c DOMAINCOMPUTER -d /dev/null -g DOMAINNAME -s /bin/false %u
        domain logons = Yes
        os level = 65
        preferred master = Yes
        domain master = Yes
        dns proxy = No
        ldap ssl = no
        panic action = /usr/share/samba/panic-action %d
        logon path = \\%L\Profiles\%U
        logon home = \\%L\%U\.profile
        hosts allow = 192.168.0. 127.
        invalid users = root
        create mask = 0775
        directory mode = 0775

Forzar la máscara de creación de nuevos archivos y directorios en todos los compartidos a 775, impedirá que la modificación de un archivo le haga imposible de escribir a otro usuario del grupo.

Sobre las líneas ''logon = ...'', leer más adelante.

Permitir a root nos capacita para unir máquinas al dominio o examinar los compartidos (porque root tiene acceso para modificar smbpasswd y useradd). Acceder a ellos requiere un usuario válido, y si entramos al PDC como root e intentamos ver un share no podremos, aun poniendo otra clave (error ''Las credenciales suministradas entran en conflicto con un conjunto de credenciales existentes'').

*http://cit.wta.swin.edu.au/cit/subjects/CITP0041/lilydale/SecurityIdentifierNumbers.htm
*http://www.alcancelibre.org/staticpages/index.php/SAMBALDAP-CENTOS5
*http://es.tldp.org/Tutoriales/doc-openldap-samba-cups-python/

== Compartidos ==
En un dominio, los permisos de acceso a recursos compartidos se establecen en función de DOMAIN\USER . A pesar que pueden añadirse equipos en la ficha Permisos, éstos no tienen esa función, ya que un equipo no es un principio de seguridad. Sin embargo, por grupos de trabajo sí que se pueden establecer este tipo de permisos, ya que un usuario es de una máquina, así que aunque especificas realmente el usuario, como el usuario no está centralizado en un dominio sino que está ligado a una máquina, parece que concedes el acceso a la máquina. Por lo tanto, no pueden especificarse equipos a la hora de establecer permisos en un dominio. Es necesario hacerlo a través del usuario que loguea.

=== Estableciendo compartidos ===
Hacer una sección [NOMBRE DEL COMPARTIDO] en /etc/samba/smb.conf . Debe estar entre corchetes y puede tener espacios.
Añadir los parámetros path, que asocia el compartido con un directorio local, y añadir los permisos Samba.
*valid users , Indica qué usuarios pueden examinar el recurso. Si no se especifica, todos pueden examinarlo.
*write list , Establece quienes pueden escribir en el recurso.

Al acceder a una carpeta de red, primero se aplican los permisos Samba y a continuación, los permisos UNIX. El directorio especificado en el path debe tener los mismos permisos (o menos restrictivos, por que ya restringe Samba) que los especificados en smb.conf .

=== Examinando compartidos ===
En una shell, tenemos el comando:
 smbclient -L ip_o_netbiosname [-U usuario[%contraseña]]
A continuación, se monta en el sistema de archivos raíz:
 mount -t smbfs //server/share /mnt -o username=xxx,password=xxx

Las máquinas Windows unidas al dominio sólo presentan su contraseña en el logueo. Las máquinas no unidas al dominio han de presentar la clave en cada acceso a un recurso. Estas contraseñas se almacenan en Panel de Control, Usuarios, [http://support.microsoft.com/kb/306541 Nombres de usuario y contraseñas almacenadas].

=== Leyendo compartidos ===
Detalles varios:
 -Uuser%pass un usuario y clave en smbclient
 -U% anónimo en smbclient
 chmod +S /usr/bin/smbclient para que un usuario pueda montar
 chown u:u /mnt para escribir dentro
 en fstab //kk/k /mnt smbfs rw,noauto,users,user=kk,passwd=kk 0 0

== Usuarios ==
Cada usuario de un dominio Windows tiene un nombre de inicio de sesión. Este nombre existe en Samba, y es un nombre de usuario del sistema UNIX.

Ser usuario Samba implica ser usuario UNIX. Ser usuario UNIX no implica ser usuario Samba. La clave de los usuarios Samba no tienen por qué ser iguales a la de su correspondiente usuario UNIX.

Existe la posibilidad de asignar múltiples nombres a un mismo usuario en el fichero /etc/samba/smbusers. Por ejemplo:
 # Unix_name = SMB_name1 SMB_name2 ...
 root = administrador
 nobody = invitado guest
Así mapeamos al clásico administrador de Windows con el root.

Estos usuarios UNIX no necesitan tener directorio home (si no queremos hacer uso del share "homes") ni shell.
Dependiendo si en smbd.conf se usó como passdb backend (almacén de contraseñas) a tdbsam o a smbpasswd, las claves se guardan en /var/lib/samba/passdb.tbd (binario) o en /etc/samba/smbpasswd (texto plano). La base de datos tdbsam será la que utilice la próxima version de Samba, y permite modificar los scripts de inicio, etc, personalizados.
*Añadir usuario Samba: smbpasswd -a USER (pdbedit -a USER)
*Cambiar clave: smbpasswd [-a] USER
*Deshabilitar usuario: smbpasswd -d USER
*Borrar usuario: smbpasswd -x USER

Podemos obtener una salida similar a cat smbpasswd mediante pdbedit -wL

Vemos una lista de usuarios:
 # pdbedit -wL | grep '\[U'

== Máquinas ==
Al unirnos a un dominio, el controlador de dominio registra además la máquina en el sistema.
En Samba, este registro convierte a la máquina en un usuario más del sistema UNIX. Esto puede hacerse manualmente:
 # useradd -c DOMAINCOMPUTER -d /dev/null -g DOMAINNAME -s /bin/false COMPUTERNAME\$
 # smbpasswd -a -m COMPUTERNAME
...o mediante la opción de smb.conf :
 add machine script = /usr/sbin/useradd -c DOMAINCOMPUTER -d /dev/null -g DOMAINNAME -s /bin/false %u
*DOMAINCOMPUTER es el campo ''nombre completo de usuario'' de /etc/passwd .
*DOMAINNAME es el grupo del sistema al que pertenecen todas las máquinas del dominio .
*COMPUTERNAME es el nombre NetBIOS de la máquina que constará igualmente en nuestro sistema.
Esta orden se ejecutará al unir una máquina al dominio, de un modo automático. No está muy claro si le gusta que una máquina se llame igual que un usuario, pese al $ del final, puede dar error. Tampoco pueden reunirse máquinas que ya existieran en el dominio: obtenemos un error ''El número de procedimiento está fuera de rango'', se solventa borrándola de smbpasswd y deluser.

Vemos una lista de equipos:
 # pdbedit -wL | grep '\[W'

== Compartidos opcionales del dominio ==
En un dominio han de ser públicamente accesibles dos carpetas compartidas:
*NetLogon: contiene scripts que se ejecutan al iniciar sesión en el dominio, como pueda ser sincronizar la hora, crear unidades de red u otro [http://www.faqs.org/docs/samba/ch11.html que se nos ocurra de utilidad]. El contenido del script .BAT podría ser...:
 net use h: \\192.168.0.1\HOME /persistent:no
 net time \\sambaserver /set /yes
Cuando este script contiene la creación de varias unidades de red, para no demorar su creación, anteponer el comando start, que inicia los comandos paralelamente.
 start /max logon.bat
Especificamos el recurso de red así:
 [global]
 logon script = kk.bat
 [NetLogon]
 path = /var/lib/samba/netlogon
 guest ok = Yes
Este compartido debe coincidir con un directorio de la máquina PDC, legible por cualquiera. El script de inicio puede hacerse por usuario con %U.bat .
 # mkdir /var/lib/samba/netlogon
En un Win2003 esta carpeta está en %SystemRoot%\sysvol\sysvol\DOMAINNAME\scripts .
 \\maquina\netlogon\profile\logon.bat
*http://www.robvanderwoude.com/ntstart.html
*http://support.microsoft.com/?scid=kb%3Ben-us%3B265016&x=18&y=14

*Profiles
 [Profiles]
 path = /var/lib/samba/profiles
 read only = No
 create mask = 0600
 directory mask = 0700
 guest ok = Yes
Bajo este recurso se almacena un perfil de cada usuario, similar en estructura al que se pueda encontrar en su Document and Settings local. Crear un directorio de este modo:
 # mkdir /var/lib/samba/profiles
 # chmod 777 /var/lib/samba/profiles
Cada perfil (directorio dentro de esta carpeta) es propiedad del usuario Samba/UNIX y del grupo UNIX al que pertenece.

*http://www.samba.netfirms.com/PDC.htm
*http://www.faqs.org/docs/samba/toc.html
*http://www.linuxfocus.org/Castellano/March2002/article177.shtml

== Perfiles ==
Las preferencias personales, los favoritos, el historial, cuentas de correo, archivos temporales, etc... son los archivos que forman parte del perfil. Se manifiesta como una carpeta con el nombre del usuario (en una forma más general como usuario.DOMINIO.nnn en sucesivos logins), bajo %SystemRoot%\Documents and Settings.
Cuando funcionamos bajo un dominio, esta carpeta de perfil puede almacenarse en el servidor, y estar sincronizada con el perfil local. De este modo, al loguearnos en otra estación de trabajo del dominio, obtenemos nuestras preferencias y ficheros. No todas las carpetas son almacenadas en el servidor, ocasionaría gran tráfico de red. Las carpetas más pesadas se excluyen. La lista que especifica las exclusiones está en ntuser.ini.

Distinguimos dos tipos:
*Itinerantes (''roaming profiles''). Al loguearse por primera vez en el dominio se crea en el compartido Profiles copiando del PC local una estructura básica, y también en el PC local. Si ya existe, al loguearnos nos descargamos ese perfil. Al salir, se copia otra vez al server, a Profiles, excepto las carpetas indicadas en ntuser.ini . Esta posibilidad es útil cuando hay un usuario por cada persona que utiliza un ordenador. Bajo el [global] de smb.conf:
        logon path = \\%L\Profiles\%U
        logon home = \\%L\%U\.profile
*Locales (''local profiles''). Se crea exclusivamente en el PC local. El servidor no guarda datos de las estaciones de trabajo. Esta posibilidad es útil cuando hay un usuario genérico por cada persona que utiliza un ordenador. Bajo el [global] de smb.conf:
        logon path =
        logon home =
Es obligatorio declarar estos parámetros en vacío. Cuando el sistema está configurado como PDC (domain logons) presupone que los perfiles son móviles, pero sin embargo no es capaz de encontrarlos.

Samba, como vemos, puede obligar al uso de perfiles locales o centralizados en el PDC. Sin embargo, existe la posibilidad de, aún usando perfiles itinerantes, que ciertas [http://samba.org/samba/docs/man/Samba-HOWTO-Collection/ProfileMgmt.html#id2663642 estaciones de trabajo empleen sus perfiles locales], cambiando configuraciones del sistema localmente.

== Uniéndonos a un dominio ==
El proceso de unión para workstations Windows dominio es idéntico al realizado contra un Windows Server, salvo que, la cuenta que se emplea para ello es ''root'' con la contraseña Samba, y no una cuenta cualquiera. Asegurarse que invalid users = root no esté indicado; al menos mientras unamos equipos al dominio.

El proceso de unión para workstations Linux se explica [[Ubuntu|en otro artículo]].

Los equipos nuevos, con el comando ''net join'' lo que hacen es registrar su nombre NetBIOS en las claves Samba y UNIX del controlador.
Sin embargo, para los equipos que ya estuvieran unidos al dominio con un mismo nombre de dominio, en caso de reemplazar el PDC por nuestro Samba (el nombre del dominio es el mismo que antes), suceden cosas distintas en función del sistema operativo:
*equipo WXP: el cambio de PDC es transparente y no ha habido que reunir el equipo. Pero no se crea una entrada en la lista de claves (no se autentifica el equipo).
*equipo W2000: el cambio del PDC imposibilita el login de la estación, con el error ''El sistema no puede iniciar sesión en el dominio por que falta la cuenta de equipo en el dominio primario o la contraseña en esta cuenta no es correcta''. La solución es tediosa: entrar como admin del equipo, unirse al dominio, entrar como usuario, salir y entrar como administrador, y copiar en la carpeta creada en Documents and Settings para el nuevo usuario el contenido de la antigua carpeta. Al reunirse al dominio se reautentifica el equipo en la lista de claves. Peor aún, si no podemos unirnos al dominio por que el que aparece es el mismo al que nos queremos unir, habría que separarse primero yendo a un grupo de trabajo (lo cual nos permitirá también cambiar el nombre al equipo), reiniciando, y volviendo a unirse. Una clave del registro establece propiedades para cada código de usuario SID, entre otras la carpeta de almacén de su perfil ( http://support.microsoft.com/kb/314045 ).

Como no detecta que el dominio nuevo sea el mismo que el viejo a pesar del mismo nombre (deben tener un diferente código), con el cable de red conectado no podemos loguearnos. Sin embargo un equipo que estaba en un dominio, si en el reinicio al llegar a la pantalla de login no detectó en la red el dominio que tenía, mostrará el escritorio del perfil del usuario del dominio sin ningún problema (como si se hubiera logueado, aunque más rápido), aunque no tiene acceso a los recursos de red. Esto tiene utilidad de cara a poder entrar en su perfil del dominio antiguo y extraer los documentos y correo.

=== Recuperación del perfil viejo ===
El equipo, como sabemos por experiencia, detecta que el dominio es distinto (tiene distinto SID), e impide el logueo (se menciona arriba) del usuario antiguo (aunque exista con la misma cuenta o nombre de usuario). Cambiar el SID no sirve, así que el proceso a segir para mantener el perfil sin la ''paliza'' que supone migrar los correos antes de la unión al perfil, favoritos, escritorio... es el siguiente:
#Previamente, y ya con el dominio cambiado, quitar el cable de red y entrar al equipo con la cuenta antigua. Exportar el Outlook por si tuviera Exchange.
#Loguear ahora como administrador, unir al dominio nuevo.
#Loguear como el usuario. Lógicamente, nos crea un perfil distinto.
#Loguear como administrador. En Mi PC, botón derecho Propiedades, pestaña Perfiles, vemos el perfil de usuario antiguo marcado como Cuenta desconocida (sobre la cual no podemos hacer nada). En el registro HK_LM\Software\Microsoft\Windows NT\Current Version\Profile List vemos las cuentas del equipo con sus SID. Editar la clave ProfileImagePath del usuario del nuevo dominio y hacerle que use la ruta del viejo perfil.
#Como el nuevo usuario no es administrador, al loguearse creará un nuevo perfil porque no pudo acceder a la que especificamos. Ir a Panel de Control, Usuarios, Agregar, introducir el nombre del usuario y el dominio, y marcarle como Administrador (en Otros). De este modo, el usuario será admin del equipo, podrá añadir impresoras y además accederá a la carpeta de perfil del viejo usuario.
Supuestamente Microsoft tiene la User State Migration Tool para esta finalidad, aunque no ha sido probada.

=== El identificador de seguridad ===
El dominio no es más que un conjunto de ordenadores en red con una política de seguridad común, centralizada en el controlador de dominio. Cada elemento del dominio tiene un identificador de seguridad, el SID, único para cada usuario, grupo o máquina. El SID de los usuarios y grupos es relativo al SID del dominio (esto es el RID, Relative ID). Por lo tanto, al contrario que UNIX, Windows agrupa en el mismo espacio de nombres usuarios y máquinas.
En Samba se ven mediante:
 $ net rpc info
 # net getlocalsid NOSTEL #sin parámetros busca el sid del hostname, que no lo encuentra
 SID for domain NOSTEL is: S-1-5-21-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxx
Cambiar el SID en Samba mediante net setlocalsid . En Windows con [http://www.microsoft.com/technet/sysinternals/Security/NewSid.mspx newsid]. Cambiar el SID de un NTUSER.DAT con ''profiles -c S-1-5-500 -n S-1-5-502 NTUSERT.DAT'' .

== Grupos de usuarios ==
Los grupos de Windows (Administradores, Usuarios, Admins. del dominio, ...) [http://www.linuxparatodos.net/geeklog/staticpages/index.php?page=13-como-samba los podemos mapear] con grupos de usuarios UNIX, para así asignar derechos desde Windows.
Por defecto Samba viene con los grupos, pero en inglés, y solamente funcionaría con instalaciones de Windows en inglés. Podemos ver qué grupos son estos con el comando:
 # net groupmap list
Para las instalaciones en otro idioma, es preciso remapear estos grupos Windows con su nombre en español, y posteriormente emparejarles con un grupo del sistema UNIX. Teniendo ya los grupos UNIX creados con sus respectivos usuario miembros, la reasignación se hace con un comando de una sola línea:
 # net groupmap modify ntgroup="Admins. del dominio" sid="S-1-5-21-XXX-512" unixgroup="admins_dominio" \
 comment="Administradores designados del dominio"
El parámetro ntgroup debe coincidir con el nombre de ese grupo en el idioma de Windows, el sid sale de la lista obtenida con net groupmap list y unixgroup establece el nombre del grupo del sistema UNIX que mapea con los usuarios Windows.

== SWAT: Samba Web Administration Tool ==
SWAT es una herramienta que nos ayuda a configurar un servidor Samba desde una interfaz gráfica a través de web, facilitando algunas tareas para los no-iniciados.
Se ejecuta desde inetd (ha de estar habilitado en inetd.conf) y puede restringirse su acceso a ciertos equipos en el fichero hosts.allow.
 swat : 192.168.1.91 : allow
 swat : ALL : deny
 # killall -HUP inetutils-inetd
Se accede a través de http://DOMAINCONTROLLERIP:901/ .

Esta herramienta edita archivos de configuración y para servicios, así que necesita el acceso de root.
Hay que establecerle una contraseña si no la tuviera.

SWAT es útil en las fases iniciales de la configuración. Al concluir las mismas, podemos dejar de usarlo (parando inetutils-inetd o comentando la línea de swat en /etc/inetd.conf) y quitando la contraseña de root.

Otros GUIs los podemos encontrar en http://us1.samba.org/samba/GUI/